
/*-- ============================================================================================================================
-- Author:          Microsoft
-- Created date: 	Jan-29-2020

-- Description:     These test cases are for SP [usp_GetLogisticDetails]

-- Database backup Used:	qat_appdb_29Jan2020_154246
-- ==============================================================================================================================*/

-- Note: This Unit test is specifically for the Bug-27772



exec [Admin].usp_GetLogisticDetails 10, '2020-01-23', '2020-01-23', 30

-- Output
/*
Movement	StorageSource	ProductOrigin	StorageDestination	ProductDestination	OrderPurchase	PosPurchase	Value	Uom	Finding	Diagnostic	Impact	Solution	Status	Order	DateOperation
Drenaje de sistemas	TR POZOS COLORADOS-GALAN 14":TR POZOS COLORADOS-GALAN 14" : INV TRANSITO	NAFTA IMPORTADA	TR COPEY:TR COPEY : PROD TERMINADO	NAFTA IMPORTADA			86.9100000000000000	Bbl	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE			23/01/2020
Traslado	TR POZOS COLORADOS-GALAN 14":TR POZOS COLORADOS-GALAN 14" : INV TRANSITO	GASOLINA MOTOR REGULAR IMPORTADA	TR GALAN:TR GALAN : PROD TERMINADO	GASOLINA MOTOR REGULAR IMPORTADA			129847.0000000000000000	Bbl	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE			23/01/2020
Traslado centro a centro	TR AYACUCHO:TR AYACUCHO : PROD TERMINADO	NAFTA IMPORTADA	TR POZOS COLORADOS-GALAN 14":TR POZOS COLORADOS-GALAN 14" : INV TRANSITO	NAFTA IMPORTADA			69800.3300000000000000	Bbl	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE			23/01/2020
Traslado centro a centro	TR POZOS COLORADOS:TR POZOS COLORADOS : PROD TERMINADO	ACEM	TR POZOS COLORADOS-GALAN 14":TR POZOS COLORADOS-GALAN 14" : INV TRANSITO	ACEM			58711.8800000000000000	Bbl	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE			23/01/2020
Traslado de productos	TR POZOS COLORADOS-GALAN 14":TR POZOS COLORADOS-GALAN 14" : INV TRANSITO	ACEM	TR POZOS COLORADOS-GALAN 14":TR POZOS COLORADOS-GALAN 14" : INV TRANSITO	GASOLINA MOTOR REGULAR IMPORTADA			59361.3955580625000000	Bbl	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE			23/01/2020
Traslado de productos	TR POZOS COLORADOS-GALAN 14":TR POZOS COLORADOS-GALAN 14" : INV TRANSITO	NAFTA IMPORTADA	TR POZOS COLORADOS-GALAN 14":TR POZOS COLORADOS-GALAN 14" : INV TRANSITO	GASOLINA MOTOR REGULAR IMPORTADA			70485.6044419375000000	Bbl	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE			23/01/2020
*/




exec [Admin].usp_GetLogisticDetails 10, '2020-01-24', '2020-01-24', 30

-- Output
/*
empty
*/


exec [Admin].usp_GetLogisticDetails 10, '2020-01-25', '2020-01-25', 30

-- Output
/*
Movement	StorageSource	ProductOrigin	StorageDestination	ProductDestination	OrderPurchase	PosPurchase	Value	Uom	Finding	Diagnostic	Impact	Solution	Status	Order	DateOperation
Drenaje de sistemas	TR POZOS COLORADOS-GALAN 14":TR POZOS COLORADOS-GALAN 14" : INV TRANSITO	NAFTA IMPORTADA	TR COPEY:TR COPEY : PROD TERMINADO	NAFTA IMPORTADA			43.4550000000000000	Bbl	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE			25/01/2020
Traslado	TR POZOS COLORADOS-GALAN 14":TR POZOS COLORADOS-GALAN 14" : INV TRANSITO	GASOLINA MOTOR REGULAR IMPORTADA	TR GALAN:TR GALAN : PROD TERMINADO	GASOLINA MOTOR REGULAR IMPORTADA			64923.5000000000000000	Bbl	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE			25/01/2020
Traslado centro a centro	TR AYACUCHO:TR AYACUCHO : PROD TERMINADO	NAFTA IMPORTADA	TR POZOS COLORADOS-GALAN 14":TR POZOS COLORADOS-GALAN 14" : INV TRANSITO	NAFTA IMPORTADA			34900.1650000000000000	Bbl	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE			25/01/2020
Traslado centro a centro	TR POZOS COLORADOS:TR POZOS COLORADOS : PROD TERMINADO	ACEM	TR POZOS COLORADOS-GALAN 14":TR POZOS COLORADOS-GALAN 14" : INV TRANSITO	ACEM			29649.4994000000000000	Bbl	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE			25/01/2020
Traslado de productos	TR POZOS COLORADOS-GALAN 14":TR POZOS COLORADOS-GALAN 14" : INV TRANSITO	ACEM	TR POZOS COLORADOS-GALAN 14":TR POZOS COLORADOS-GALAN 14" : INV TRANSITO	GASOLINA MOTOR REGULAR IMPORTADA			649.3955580625370000	Bbl	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE			25/01/2020
Traslado de productos	TR POZOS COLORADOS-GALAN 14":TR POZOS COLORADOS-GALAN 14" : INV TRANSITO	NAFTA IMPORTADA	TR POZOS COLORADOS-GALAN 14":TR POZOS COLORADOS-GALAN 14" : INV TRANSITO	GASOLINA MOTOR REGULAR IMPORTADA			685.6044419374630000	Bbl	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE			25/01/2020
*/





exec [Admin].usp_GetLogisticDetails 10, '2020-01-23', '2020-01-25', 30

-- Output
/*
Movement	StorageSource	ProductOrigin	StorageDestination	ProductDestination	OrderPurchase	PosPurchase	Value	Uom	Finding	Diagnostic	Impact	Solution	Status	Order	DateOperation
Drenaje de sistemas	TR POZOS COLORADOS-GALAN 14":TR POZOS COLORADOS-GALAN 14" : INV TRANSITO	NAFTA IMPORTADA	TR COPEY:TR COPEY : PROD TERMINADO	NAFTA IMPORTADA			43.4550000000000000	Bbl	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE			25/01/2020
Drenaje de sistemas	TR POZOS COLORADOS-GALAN 14":TR POZOS COLORADOS-GALAN 14" : INV TRANSITO	NAFTA IMPORTADA	TR COPEY:TR COPEY : PROD TERMINADO	NAFTA IMPORTADA			86.9100000000000000	Bbl	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE			23/01/2020
Traslado	TR POZOS COLORADOS-GALAN 14":TR POZOS COLORADOS-GALAN 14" : INV TRANSITO	GASOLINA MOTOR REGULAR IMPORTADA	TR GALAN:TR GALAN : PROD TERMINADO	GASOLINA MOTOR REGULAR IMPORTADA			64923.5000000000000000	Bbl	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE			25/01/2020
Traslado	TR POZOS COLORADOS-GALAN 14":TR POZOS COLORADOS-GALAN 14" : INV TRANSITO	GASOLINA MOTOR REGULAR IMPORTADA	TR GALAN:TR GALAN : PROD TERMINADO	GASOLINA MOTOR REGULAR IMPORTADA			129847.0000000000000000	Bbl	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE			23/01/2020
Traslado centro a centro	TR AYACUCHO:TR AYACUCHO : PROD TERMINADO	NAFTA IMPORTADA	TR POZOS COLORADOS-GALAN 14":TR POZOS COLORADOS-GALAN 14" : INV TRANSITO	NAFTA IMPORTADA			34900.1650000000000000	Bbl	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE			25/01/2020
Traslado centro a centro	TR AYACUCHO:TR AYACUCHO : PROD TERMINADO	NAFTA IMPORTADA	TR POZOS COLORADOS-GALAN 14":TR POZOS COLORADOS-GALAN 14" : INV TRANSITO	NAFTA IMPORTADA			69800.3300000000000000	Bbl	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE			23/01/2020
Traslado centro a centro	TR POZOS COLORADOS:TR POZOS COLORADOS : PROD TERMINADO	ACEM	TR POZOS COLORADOS-GALAN 14":TR POZOS COLORADOS-GALAN 14" : INV TRANSITO	ACEM			29649.4994000000000000	Bbl	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE			25/01/2020
Traslado centro a centro	TR POZOS COLORADOS:TR POZOS COLORADOS : PROD TERMINADO	ACEM	TR POZOS COLORADOS-GALAN 14":TR POZOS COLORADOS-GALAN 14" : INV TRANSITO	ACEM			58711.8800000000000000	Bbl	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE			23/01/2020
Traslado de productos	TR POZOS COLORADOS-GALAN 14":TR POZOS COLORADOS-GALAN 14" : INV TRANSITO	ACEM	TR POZOS COLORADOS-GALAN 14":TR POZOS COLORADOS-GALAN 14" : INV TRANSITO	GASOLINA MOTOR REGULAR IMPORTADA			649.3955580625370000	Bbl	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE			25/01/2020
Traslado de productos	TR POZOS COLORADOS-GALAN 14":TR POZOS COLORADOS-GALAN 14" : INV TRANSITO	ACEM	TR POZOS COLORADOS-GALAN 14":TR POZOS COLORADOS-GALAN 14" : INV TRANSITO	GASOLINA MOTOR REGULAR IMPORTADA			59361.3955580625000000	Bbl	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE			23/01/2020
Traslado de productos	TR POZOS COLORADOS-GALAN 14":TR POZOS COLORADOS-GALAN 14" : INV TRANSITO	NAFTA IMPORTADA	TR POZOS COLORADOS-GALAN 14":TR POZOS COLORADOS-GALAN 14" : INV TRANSITO	GASOLINA MOTOR REGULAR IMPORTADA			685.6044419374630000	Bbl	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE			25/01/2020
Traslado de productos	TR POZOS COLORADOS-GALAN 14":TR POZOS COLORADOS-GALAN 14" : INV TRANSITO	NAFTA IMPORTADA	TR POZOS COLORADOS-GALAN 14":TR POZOS COLORADOS-GALAN 14" : INV TRANSITO	GASOLINA MOTOR REGULAR IMPORTADA			70485.6044419375000000	Bbl	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE	LOGISTIC_FILE_STATIC_MESSAGE			23/01/2020
*/




--=====================================================================================================================

-- Below script was used to raise the Bug.

Select ORN.NodeId			As [SourceNodeId]
	, ORN.Name				As [SourceNode]
	, DSN.NodeId			As [DestinationNodeId]
	, DSN.Name				As [DestinationNode]
	, P.Name				As [SourceProduct]
	, PD.Name				As [DestinationProduct] 
	, MT.Name				As [MovementType]	
	, O.Name				As [Owner]
	, PD.ProductId 
	, OS.OwnershipPercentage
	, OS.OwnershipVolume
	, M.OperationalDate
From Offchain.Ownership OS 
	Inner Join [Offchain].[Movement] M On M.MovementTransactionId = OS.MovementTransactionId
	Left  Join [Offchain].[MovementSource] MS On MS.[MovementTransactionId] = M.MovementTransactionId
	Left  Join Admin.Node ORN On ORN.NodeId = MS.SourceNodeId
	Left  Join [Offchain].[MovementDestination] MD On MD.[MovementTransactionId] = M.MovementTransactionId
	Left  Join Admin.Node DSN On DSN.NodeId = MD.DestinationNodeId
	Left  Join Admin.Product P On P.ProductId = MS.SourceProductId
	Left  Join Admin.Product PD On PD.ProductId = MD.DestinationProductId
	Left  Join Admin.CategoryElement MT On CAST(MT.ElementId AS NVARCHAR(150)) = M.MovementTypeId
		And MT.CategoryId = 9 
	Left  Join Admin.CategoryElement O On O.ElementId = OS.OwnerId
Where 
	O.ElementId = 30 --Ecopetrol
	And M.OperationalDate Between '2020-01-23' And '2020-01-25'
	And DSN.SendToSAP = 1
	And ORN.SendToSAP = 1



-- Output
/*
SourceNodeId	SourceNode	DestinationNodeId	DestinationNode	SourceProduct	DestinationProduct	MovementType	Owner	ProductId	OwnershipPercentage	OwnershipVolume	OperationalDate
8	POZOS COLORADOS	23	POZOS COLORADOS-GALAN 14"	ACEM	ACEM	DESPACHO A LINEA	ECOPETROL	30000000003	100.0000000000000000	58711.8800000000000000	2020-01-23 00:00:00.000
24	AYACUCHO - REF	23	POZOS COLORADOS-GALAN 14"	NAFTA IMPORTADA	NAFTA IMPORTADA	DESPACHO A LINEA	ECOPETROL	30000000045	100.0000000000000000	69800.3300000000000000	2020-01-23 00:00:00.000
23	POZOS COLORADOS-GALAN 14"	25	EL COPEY	NAFTA IMPORTADA	NAFTA IMPORTADA	DRENAJE DE SISTEMAS	ECOPETROL	30000000045	100.0000000000000000	86.9100000000000000	2020-01-23 00:00:00.000
23	POZOS COLORADOS-GALAN 14"	26	GALAN - Transporte	GASOLINA MOTOR REGULAR IMPORTADA	GASOLINA MOTOR REGULAR IMPORTADA	RECIBO DE LINEA	ECOPETROL	30000000517	100.0000000000000000	129847.0000000000000000	2020-01-23 00:00:00.000
23	POZOS COLORADOS-GALAN 14"	26	GALAN - Transporte	GASOLINA MOTOR REGULAR IMPORTADA	GASOLINA MOTOR REGULAR IMPORTADA	RECIBO DE LINEA	ECOPETROL	30000000517	50.0000000000000000	64923.5000000000000000	2020-01-25 00:00:00.000
24	AYACUCHO - REF	23	POZOS COLORADOS-GALAN 14"	NAFTA IMPORTADA	NAFTA IMPORTADA	DESPACHO A LINEA	ECOPETROL	30000000045	50.0000000000000000	34900.1650000000000000	2020-01-25 00:00:00.000
23	POZOS COLORADOS-GALAN 14"	25	EL COPEY	NAFTA IMPORTADA	NAFTA IMPORTADA	DRENAJE DE SISTEMAS	ECOPETROL	30000000045	50.0000000000000000	43.4550000000000000	2020-01-25 00:00:00.000
8	POZOS COLORADOS	23	POZOS COLORADOS-GALAN 14"	ACEM	ACEM	DESPACHO A LINEA	ECOPETROL	30000000003	50.5000000000000000	29649.4994000000000000	2020-01-25 00:00:00.000
23	POZOS COLORADOS-GALAN 14"	23	POZOS COLORADOS-GALAN 14"	NAFTA IMPORTADA	GASOLINA MOTOR REGULAR IMPORTADA	Traslado de productos	ECOPETROL	30000000517	100.0000000000000000	70485.6044419375000000	2020-01-23 00:00:00.000
23	POZOS COLORADOS-GALAN 14"	23	POZOS COLORADOS-GALAN 14"	ACEM	GASOLINA MOTOR REGULAR IMPORTADA	Traslado de productos	ECOPETROL	30000000517	100.0000000000000000	59361.3955580625000000	2020-01-23 00:00:00.000
23	POZOS COLORADOS-GALAN 14"	23	POZOS COLORADOS-GALAN 14"	NAFTA IMPORTADA	GASOLINA MOTOR REGULAR IMPORTADA	Traslado de productos	ECOPETROL	30000000517	100.0000000000000000	685.6044419374630000	2020-01-25 00:00:00.000
23	POZOS COLORADOS-GALAN 14"	23	POZOS COLORADOS-GALAN 14"	ACEM	GASOLINA MOTOR REGULAR IMPORTADA	Traslado de productos	ECOPETROL	30000000517	100.0000000000000000	649.3955580625370000	2020-01-25 00:00:00.000
*/

